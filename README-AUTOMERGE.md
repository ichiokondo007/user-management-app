# Automerge Repo v2.0 同時編集機能

このアプリケーションは**Automerge Repo v2.0**を使用して、リアルタイム同時編集機能を実装しています。

## 🚀 セットアップと起動

### 方法1: 自動起動（推奨）
```bash
npm start
```

### 方法2: 手動起動
1. **Automerge WebSocketサーバーを起動**:
```bash
npm run server
```

2. **Reactアプリを起動** (別ターミナル):
```bash
npm run dev
```

これにより以下が起動します：
- **Automerge WebSocketサーバー**: `ws://localhost:3030`
- **Reactアプリ**: `http://localhost:5173`

## 使い方

### 同時編集のテスト手順

1. **1つ目のブラウザ（またはタブ）を開く**
   - `http://localhost:5173` にアクセス
   - 画面上部のユーザー名入力欄に任意の名前（例：`user1`）を入力
   - ユーザー一覧から任意のユーザーの「編集」ボタンをクリック

2. **2つ目のブラウザ（または別のタブ/プライベートウィンドウ）を開く**
   - `http://localhost:5173` にアクセス
   - **同じユーザー名**（例：`user1`）を入力 ← 重要！
   - 同じユーザーの「編集」ボタンをクリック

3. **リアルタイム同期を確認**
   - どちらかのブラウザで「ユーザ名」「住所」「メモ」を編集
   - もう一方のブラウザに自動的に反映されることを確認

## 🔧 技術仕様

### コア技術
- **Automerge Repo v2.0**: CRDTベースの分散型データ同期ライブラリ
- **WebSocketServerAdapter**: Automerge公式のWebSocket同期アダプター
- **IndexedDB**: クライアント側永続ストレージ
- **NodeFS**: サーバー側永続ストレージ

### アーキテクチャ
- **peerId**: ユーザー名を使用（同じユーザー名 = 同じ編集セッション）
- **ドキュメントID**: `user-{userId}` 形式
- **型安全性**: TypeScriptで完全に型付け

## 🔄 接続管理

### クライアント側
- **編集画面への遷移時**: 
  - Automerge Repoインスタンスを作成
  - WebSocket接続を確立
  - ドキュメントハンドルを取得/作成
- **一覧画面への戻り時**: 
  - WebSocket接続を自動切断
  - リソースをクリーンアップ

### サーバー側
- **Automerge WebSocketServerAdapter**: 公式アダプターを使用
- **永続化**: `server/automerge-data/` ディレクトリに自動保存
- **自動管理**: Automerge Repoによる自動的なドキュメント管理

## ⚠️ 注意事項

- ユーザー名が異なる場合は、別々の編集セッションとなり同期されません
- 新規ユーザー作成画面では同期機能は動作しません（既存ユーザー編集のみ）
- WebSocketサーバーが起動していない場合、同期機能は動作しません
- ドキュメントはサーバー側で永続化されます